---
title: "Workshop 3 Preview: Advanced Networking (Exercises 6-8)"
subtitle: "Part 3 of 3: Wireless Tuning, Congestion Handling, and NAT Traversal"
author: "Rajesh"
date: "2025-12-17T11:00:00"
categories: [ros2, zenoh, workshop, roscon-india, networking, performance]
image: "thumbnail.png"
toc: true
toc-depth: 3
code-fold: true
code-summary: "Show code"
---

## Series Overview

This is Part 3 (final) of the Workshop 3 exercise preview:

| Part | Exercises | Focus |
|------|-----------|-------|
| Part 1 | 1-3 | Fundamentals: Pub/Sub, QoS, Shared Memory |
| Part 2 | 4-5 | Remote: Cloud Router, mTLS Security |
| **Part 3 (This Post)** | 6-8 | Advanced: Wireless, Congestion, NAT |

---

## Exercise 6: Wireless Performance Tuning

### The WiFi Challenge

WiFi introduces challenges that wired Ethernet doesn't have:

| Challenge | Impact | Mitigation |
|-----------|--------|------------|
| **Variable latency** | 5-100ms jitter | Increase buffers |
| **Packet loss** | 1-5% typical | Enable reliability |
| **Half-duplex** | Can't TX and RX simultaneously | Reduce bandwidth |
| **Interference** | Other devices, microwaves | Choose channels wisely |

### Bandwidth Reality Check

**Theoretical vs Real WiFi throughput:**

| WiFi Standard | Theoretical | Real-World | With Interference |
|---------------|-------------|------------|-------------------|
| 802.11n (WiFi 4) | 300 Mbps | 100-150 Mbps | 50-80 Mbps |
| 802.11ac (WiFi 5) | 867 Mbps | 300-500 Mbps | 150-250 Mbps |
| 802.11ax (WiFi 6) | 1200 Mbps | 500-700 Mbps | 300-400 Mbps |

**Robot sensor bandwidth:**

| Sensor | Bandwidth |
|--------|-----------|
| 720p Camera @ 30 FPS | ~27 MB/s (216 Mbps) |
| Depth Camera @ 30 FPS | ~18 MB/s (144 Mbps) |
| LIDAR @ 20 Hz | ~2 MB/s (16 Mbps) |
| **Total** | **~47 MB/s (376 Mbps)** |

![Robot sensor bandwidth often exceeds real-world WiFi capacity](wifi-bandwidth-challenge.png){#fig-wifi-challenge}

::: {.callout-warning}
## The Math Doesn't Work
A Go2 robot publishing full sensor data (~47 MB/s) **exceeds** typical WiFi 5 real-world throughput. Without optimization, you'll experience:
- Packet loss
- Latency spikes
- Dropped connections
:::

### Linux Kernel Tuning

```bash
# Increase network buffer sizes
sudo sysctl -w net.core.rmem_max=16777216
sudo sysctl -w net.core.wmem_max=16777216
sudo sysctl -w net.core.rmem_default=1048576
sudo sysctl -w net.core.wmem_default=1048576

# Use BBR congestion control (better for WiFi)
sudo sysctl -w net.ipv4.tcp_congestion_control=bbr

# Increase backlog for burst handling
sudo sysctl -w net.core.netdev_max_backlog=10000
```

### Topic Filtering: The Biggest Win

Instead of sending everything, **filter at the source**:

```bash
# Before: All 47 topics bridged = 50 MB/s
zenoh-bridge-ros2dds

# After: Only essential topics = 100 KB/s
zenoh-bridge-ros2dds \
    --allow "/cmd_vel" \
    --allow "/odom" \
    --allow "/battery_state" \
    --deny ".*"
```

| Configuration | Bandwidth | Reduction |
|---------------|-----------|-----------|
| All topics | 50 MB/s | - |
| Navigation only | 3 MB/s | 94% |
| Telemetry only | 100 KB/s | **99.8%** |

### Hands-On Testing: Simulating WiFi Congestion

![Using Linux Traffic Control to simulate WiFi congestion](traffic-control-simulation.png){#fig-tc-simulation}

We tested with a RealSense D435i camera (720p @ 30 FPS) using Linux Traffic Control to simulate WiFi congestion:

```bash
# Baseline (no limits)
ros2 topic bw /camera/camera/color/image_raw
# Result: 84-86 MB/s, 30 FPS, 2.76 MB per frame

# Simulate congested WiFi (200 Mbps + 10ms jitter)
tc qdisc add dev lo root netem delay 10ms 5ms rate 200mbit

# Measure again
ros2 topic hz /camera/camera/color/image_raw
# Result: ~5 FPS (83% drop!)
```

::: {.callout-important}
## Eureka Moment #1: 83% FPS Drop!
With 200 Mbps bandwidth limit, our 720p camera dropped from **30 FPS to just 5 FPS**. Why? The camera produces 84 MB/s (672 Mbps), but we only had 200 Mbps available!
:::

### The Compression Solution

The D435i publishes multiple formats via `image_transport`. Here's what we measured:

| Topic | Size | FPS (Congested) | Compression |
|-------|------|-----------------|-------------|
| `/image_raw` | 2.76 MB | **~5 FPS** | 1x (baseline) |
| `/image_raw/zstd` | 1.45 MB | ~12 FPS | 1.9x |
| **`/image_raw/compressed`** | **0.23 MB** | **~30 FPS** | **12x smaller!** |
| `/depth/image_rect_raw` | 0.81 MB | ~30 FPS | N/A |

![Compression dramatically reduces bandwidth while maintaining frame rate](compression-bandwidth-comparison.png){#fig-compression}

::: {.callout-tip}
## Eureka Moment #2: JPEG Compression is the WiFi Solution!
The JPEG compressed topic (0.23 MB) achieves **full 30 FPS** on the same congested network where raw (2.76 MB) only gets 5 FPS. That's a **12x size reduction** with no FPS loss!
:::

### Who Does the Compression?

**The `image_transport` ROS 2 package does it automatically!** When you launch the camera, these topics appear:

- `/image_raw` - Original uncompressed
- `/image_raw/compressed` - JPEG compressed
- `/image_raw/zstd` - ZSTD compressed
- `/image_raw/theora` - Video codec

**No extra configuration needed** - just subscribe to `/compressed` instead of `/image_raw`.

### Traffic Control Quick Reference

```bash
# Add bandwidth limit with delay
tc qdisc add dev lo root netem delay 10ms 5ms rate 200mbit

# Remove all tc rules
tc qdisc del dev lo root

# Show current rules
tc qdisc show dev lo
```

---

## Exercise 7: Congestion Handling

### Head-of-Line Blocking

When a network is congested, messages queue up. If one stream blocks, **all streams** may be affected:

![Head-of-line blocking: large camera frames block tiny control commands](head-of-line-blocking.png){#fig-hol-blocking}

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    HEAD-OF-LINE BLOCKING                                │
│                                                                          │
│    Publishers              Queue              Network                   │
│                                                                          │
│    /camera ─────►  ┌─────────────┐                                      │
│    (27 MB/s)       │ ███████████ │───slow────►  WiFi                    │
│                    │ ███████████ │  (blocked)  (congested)              │
│    /cmd_vel ────►  │ ░░░░░░░░░░░ │                                      │
│    (tiny)          └─────────────┘                                      │
│                          ▲                                               │
│                          │                                               │
│    /cmd_vel is BLOCKED behind /camera data!                            │
│    Control commands delayed = dangerous for robot!                      │
└─────────────────────────────────────────────────────────────────────────┘
```

### Priority Queues

Zenoh supports **priority levels** to ensure critical messages aren't blocked:

| Priority | Use Case | Example Topics |
|----------|----------|----------------|
| **Real-time** | Emergency, safety | `/emergency_stop` |
| **Interactive** | Control commands | `/cmd_vel`, `/arm_control` |
| **Data** | Sensor streams | `/camera`, `/lidar` |
| **Background** | Logs, diagnostics | `/rosout`, `/diagnostics` |

### Zenoh Priority Configuration

```json5
// zenoh_priority.json5
{
  // Define priority mappings
  qos: {
    publication: {
      // High priority for control
      "rt/cmd_vel": { priority: "real_time" },
      "rt/emergency_stop": { priority: "real_time" },

      // Normal priority for sensors
      "rt/camera/**": { priority: "data" },
      "rt/lidar/**": { priority: "data" },

      // Low priority for logs
      "rt/rosout": { priority: "background" }
    }
  }
}
```

### Flow Control Strategies

| Strategy | Description | When to Use |
|----------|-------------|-------------|
| **Drop oldest** | Discard old messages when queue full | Camera streams |
| **Drop newest** | Discard new messages when queue full | Rarely useful |
| **Block sender** | Pause publisher until queue has space | Reliable data |
| **Sample** | Only keep every Nth message | High-rate sensors |

### Hands-On Testing: cmd_vel Under Congestion

We tested with camera (large images) and cmd_vel (tiny control commands) running simultaneously:

```bash
# Start cmd_vel publisher
ros2 topic pub /cmd_vel geometry_msgs/msg/Twist \
    "{linear: {x: 0.5}, angular: {z: 0.1}}" --rate 10
```

**Baseline (No Congestion):**

| Topic | Rate | Jitter (std dev) |
|-------|------|------------------|
| `/cmd_vel` | 10 Hz | 0.0003s |
| `/camera/image_raw` | 30 FPS | 0.0005s |

**Moderate Congestion (200 Mbps + 10ms delay):**

| Topic | Rate | Jitter (std dev) |
|-------|------|------------------|
| `/cmd_vel` | 10 Hz | 0.0035s (**10x worse**) |
| `/camera/image_raw` | ~5 FPS | 0.04s |

**Severe Congestion (50 Mbps + 50ms delay):**

| Topic | Rate | Jitter (std dev) | Interval Range |
|-------|------|------------------|----------------|
| `/cmd_vel` | 10 Hz | **0.022s** | 62-135ms (expected: 100ms) |

![Small control messages slip through congestion but with increased jitter](congestion-jitter-diagram.png){#fig-congestion}

::: {.callout-warning}
## Eureka Moment #5: Zenoh Handles Small Packets Well!
**Surprising finding**: cmd_vel (tiny messages) maintained 10 Hz rate even under severe congestion! Unlike classic "head-of-line blocking", small messages slip through in Zenoh.

**BUT timing consistency degrades significantly:**
- Jitter increased **73x** (0.0003s → 0.022s)
- Interval variance: ±37ms instead of ±1ms

**Impact on Robots:**
- Jerky movement from inconsistent timing
- Control loop instability
- Path following errors
:::

**Lesson**: Priority queues help ensure **consistent timing**, not just delivery. For safety-critical systems, predictable timing matters as much as throughput.

---

## Exercise 8: NAT Traversal & Namespace Resolution

### NAT Traversal Deep Dive

While Exercise 4 introduced cloud routers, Exercise 8 explores **direct peer-to-peer** connections through NAT.

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    NAT TYPES                                             │
│                                                                          │
│    Full Cone NAT          Symmetric NAT          Port Restricted        │
│    ┌──────────┐           ┌──────────┐          ┌──────────┐           │
│    │ Any host │           │ Specific │          │ Specific │           │
│    │ can reach│           │host:port │          │ port     │           │
│    │ mapped   │           │ required │          │ required │           │
│    │ port     │           │          │          │          │           │
│    └──────────┘           └──────────┘          └──────────┘           │
│    Easy to traverse       Hard to traverse      Medium difficulty      │
└─────────────────────────────────────────────────────────────────────────┘
```

### STUN/TURN Concepts

| Protocol | Purpose | How It Works |
|----------|---------|--------------|
| **STUN** | Discover public IP/port | Client asks STUN server "what's my public address?" |
| **TURN** | Relay when direct fails | All traffic goes through TURN server |
| **ICE** | Try all methods | STUN first, fall back to TURN |

![ICE connection establishment: STUN for discovery, TURN as fallback relay](nat-traversal-ice.png){#fig-nat-ice}

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    ICE CONNECTION ESTABLISHMENT                         │
│                                                                          │
│    1. Both peers query STUN server for public address                   │
│    2. Exchange addresses through signaling (Zenoh router)               │
│    3. Try direct connection (STUN-discovered addresses)                 │
│    4. If direct fails, use TURN relay                                   │
│                                                                          │
│    Robot ◄────── STUN ──────► Server ◄────── STUN ──────► Laptop       │
│       │                                                      │          │
│       └──────────────── Direct P2P (if possible) ───────────┘          │
│                              or                                         │
│       └─────────────── TURN Relay (fallback) ───────────────┘          │
└─────────────────────────────────────────────────────────────────────────┘
```

### Namespace Resolution

When multiple robots connect to the same router, **topic collisions** occur:

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    NAMESPACE COLLISION PROBLEM                          │
│                                                                          │
│    Robot 1 publishes: /odom                                             │
│    Robot 2 publishes: /odom        ──►  Which /odom is which?!         │
│    Robot 3 publishes: /odom                                             │
└─────────────────────────────────────────────────────────────────────────┘
```

### Solution: Namespace Prefixes

```bash
# Robot 1: Prefix all topics with /robot1
ros2 run demo_nodes_cpp talker --ros-args --remap __ns:=/robot1

# Robot 2: Prefix all topics with /robot2
ros2 run demo_nodes_cpp talker --ros-args --remap __ns:=/robot2 --remap __node:=talker2

# Result:
# /robot1/chatter
# /robot2/chatter
```

::: {.callout-tip}
## Pro Tip: Use --ros-args Instead of Environment Variables
Using `--ros-args --remap __ns:=/robotX` is **more reliable** than the `ROS_NAMESPACE` environment variable, especially with rmw_zenoh_cpp.
:::

### Zenoh Namespace Mapping

```json5
// zenoh_namespace.json5
{
  // Map robot-specific namespace to Zenoh key space
  ros2dds: {
    namespace: "/go2_alpha",

    // Topic remapping
    pub: {
      "/odom": "fleet/go2_alpha/odom",
      "/cmd_vel": "fleet/go2_alpha/cmd_vel"
    }
  }
}
```

### Multi-Robot Fleet Topology

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    FLEET MANAGEMENT TOPOLOGY                            │
│                                                                          │
│                         ┌──────────────┐                                │
│                         │ Fleet Router │                                │
│                         │   (Cloud)    │                                │
│                         └──────┬───────┘                                │
│                                │                                         │
│         ┌──────────────────────┼──────────────────────┐                 │
│         │                      │                      │                 │
│    ┌────┴────┐            ┌────┴────┐            ┌────┴────┐           │
│    │ go2_001 │            │ go2_002 │            │ go2_003 │           │
│    │ /odom   │            │ /odom   │            │ /odom   │           │
│    └─────────┘            └─────────┘            └─────────┘           │
│                                                                          │
│    Zenoh Key Space:                                                     │
│    fleet/go2_001/odom                                                   │
│    fleet/go2_002/odom                                                   │
│    fleet/go2_003/odom                                                   │
└─────────────────────────────────────────────────────────────────────────┘
```

### Hands-On Testing: Multi-Robot Namespaces

We tested namespace resolution with two simulated robots:

```bash
# Start two "robots" with different namespaces
ros2 run demo_nodes_cpp talker --ros-args --remap __ns:=/robot1 &
ros2 run demo_nodes_cpp talker --ros-args --remap __ns:=/robot2 --remap __node:=talker2 &

# Check nodes
ros2 node list
# Output:
# /robot1/talker
# /robot2/talker2

# Check topics
ros2 topic list | grep robot
# Output:
# /robot1/chatter
# /robot2/chatter

# Verify independent streams
ros2 topic echo /robot1/chatter --once
# data: 'Hello World: 27'

ros2 topic echo /robot2/chatter --once
# data: 'Hello World: 29'
```

![Multiple robots with unique namespaces avoid topic collisions](namespace-fleet-diagram.png){#fig-namespace}

::: {.callout-note}
## Eureka Moment #6: Namespace Resolution Prevents Chaos!

| Robot | Node Name | Namespace | Topic |
|-------|-----------|-----------|-------|
| Robot 1 | `talker` | `/robot1` | `/robot1/chatter` |
| Robot 2 | `talker2` | `/robot2` | `/robot2/chatter` |

**Key Findings:**
- **Namespaces prevent topic collisions** - essential for multi-robot fleets
- **Each robot gets isolated topics**: `/robot1/odom`, `/robot2/odom`, etc.
- **Fleet monitoring**: Subscribe to patterns like `/robot*/status`
:::

---

## Putting It All Together

The final workshop challenge combines **all 8 exercises**:

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    COMPLETE WORKSHOP SCENARIO                           │
│                                                                          │
│    Exercise 1-3: Local robot running Zenoh + SHM                        │
│    ┌─────────────────────────────────────────────────────────┐          │
│    │  Robot (local)                                          │          │
│    │  ├─ rmw_zenoh_cpp (Ex 1)                               │          │
│    │  ├─ QoS configured (Ex 2)                              │          │
│    │  └─ SHM enabled for cameras (Ex 3)                     │          │
│    └─────────────────────────────────────────────────────────┘          │
│                          │                                               │
│                          │ WiFi (Ex 6 tuning)                           │
│                          │ Priority queues (Ex 7)                       │
│                          ▼                                               │
│    Exercise 4-5: Secure cloud connectivity                              │
│    ┌─────────────────────────────────────────────────────────┐          │
│    │  Cloud Router                                           │          │
│    │  ├─ TLS encrypted (Ex 5)                               │          │
│    │  ├─ mTLS authenticated (Ex 5)                          │          │
│    │  └─ NAT traversal (Ex 8)                               │          │
│    └─────────────────────────────────────────────────────────┘          │
│                          │                                               │
│                          ▼                                               │
│    Exercise 8: Multi-robot namespace                                    │
│    ┌─────────────────────────────────────────────────────────┐          │
│    │  Fleet Dashboard                                        │          │
│    │  ├─ /go2_001/odom                                      │          │
│    │  ├─ /go2_002/odom                                      │          │
│    │  └─ /go2_003/odom                                      │          │
│    └─────────────────────────────────────────────────────────┘          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## Workshop Preparation Summary

### What You'll Have Learned

| Exercise | Key Skill |
|----------|-----------|
| 1 | Zenoh pub/sub and discovery |
| 2 | QoS configuration and compatibility |
| 3 | Shared memory for zero-copy |
| 4 | Cloud router deployment |
| 5 | mTLS security setup |
| 6 | WiFi optimization and filtering |
| 7 | Priority queues for congestion |
| 8 | Multi-robot namespace management |

### Final Checklist

Before attending Workshop 3:

- [ ] Docker environment working
- [ ] Zenoh CLI tools installed (`zenohd`, `zenoh scout/sub/pub`)
- [ ] Basic understanding of QoS profiles
- [ ] Familiarity with Linux networking (`tc`, `sysctl`)
- [ ] OpenSSL certificate generation basics
- [ ] ROS 2 namespace concepts

---

## Resources

- [Zenoh NAT Traversal](https://zenoh.io/blog/2021-03-23-nat/)
- [ICE RFC 8445](https://datatracker.ietf.org/doc/html/rfc8445)
- [Linux Traffic Control](https://tldp.org/HOWTO/Traffic-Control-HOWTO/)
- [ROS 2 Namespaces](https://docs.ros.org/en/rolling/Tutorials/Beginner-CLI-Tools/Understanding-ROS2-Nodes/Understanding-ROS2-Nodes.html#remapping)
- [Workshop Preparation Tools](../2025-12-16-workshop3-zenoh-tools/)

---

## See Also

- [Part 1: Exercises 1-3 (Fundamentals)](../2025-12-17-workshop3-exercises-part1/)
- [Part 2: Exercises 4-5 (Remote & Security)](../2025-12-17-workshop3-exercises-part2/)
- [Our Preparation Tools](../2025-12-16-workshop3-zenoh-tools/)
- [Performance Tuning Details](../2025-12-16-workshop3-zenoh-performance/)
